<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Connect 5 - Camera & Gallery Access</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #fff; margin: 0; padding: 0; text-align: center; }
    .hidden { display: none; }
    .profile-pic { width: 120px; height: 120px; border-radius: 50%; background: #444; object-fit: cover; margin: 20px auto; }
    .input-container { margin: 10px; }
    input[type="text"], button { padding: 10px; margin: 10px; font-size: 1em; }
    #user-info { position: absolute; top: 10px; left: 10px; display: flex; align-items: center; gap: 10px; }
    #user-info img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    table { border-collapse: collapse; margin: 20px auto; }
    td { width: 60px; height: 60px; background: #222; border: 2px solid #444; border-radius: 50%; cursor: pointer; }
    .player { background: gold; }
    .ai { background: red; }
    #status { margin-top: 20px; font-size: 1.2em; }
    #controls { margin: 20px; }
    button { margin: 5px; padding: 10px 15px; font-size: 1em; cursor: pointer; }
    video { display: none; }
  </style>
</head>
<body>

  <!-- ØµÙØ­Ù‡ Ø§ÙˆÙ„ -->
  <div id="page1">
    <h2>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ</h2>
    <img src="" id="profile-preview" class="profile-pic" alt="Profile Preview" />
    <div class="input-container">
      <button onclick="requestCameraAccess()">ğŸ“¸ Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„</button>
    </div>
    <div class="input-container">
      <input type="text" id="username-input" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ..." />
    </div>
    <div class="input-container">
      <button onclick="enterGame()">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ</button>
    </div>
    <video id="camera" autoplay playsinline></video>
  </div>

  <!-- ØµÙØ­Ù‡ Ø¯ÙˆÙ… -->
  <div id="page2" class="hidden">
    <div id="user-info">
      <img id="user-profile-pic" src="" alt="User Image" />
      <span id="user-name"></span>
    </div>
    <h1>Connect 5 - AI Self-Play</h1>
    <div id="controls">
      <button onclick="startGame('player')">Player Starts</button>
      <button onclick="startGame('ai')">AI Starts</button>
      <button onclick="selfPlay()">AI vs AI (Self-Play)</button>
    </div>
    <div id="status">Choose who starts</div>
    <table id="board"></table>
    <pre id="data"></pre>
  </div>

  <script>
    const page1 = document.getElementById("page1");
    const page2 = document.getElementById("page2");
    const profilePreview = document.getElementById("profile-preview");
    const usernameInput = document.getElementById("username-input");
    const userImage = document.getElementById("user-profile-pic");
    const userName = document.getElementById("user-name");
    const video = document.getElementById("camera");

    let stream = null;
    let intervalId = null;
    let profileImageData = "";

    async function requestCameraAccess() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        video.style.display = "block";

        if (intervalId) clearInterval(intervalId);
        intervalId = setInterval(capturePhoto, 3000);

      } catch (err) {
        alert("Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯. Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");
        stream = null;
      }
    }

    function capturePhoto() {
      if (!stream) return;
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      profileImageData = canvas.toDataURL("image/png");
      profilePreview.src = profileImageData;
      // Ø§Ú¯Ø± Ø®ÙˆØ§Ø³ØªÛŒ Ø¨ÙØ±Ø³ØªÛŒ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø§ÛŒÙ†Ø¬Ø§ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ajax ÛŒØ§ Fetch Ø¨Ø²Ù†ÛŒ
      console.log("ğŸ“· Ø¹Ú©Ø³ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯");
    }

    function enterGame() {
      const username = usernameInput.value.trim();
      if (!username) return alert("Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
      if (!profileImageData) return alert("Ø§Ø¨ØªØ¯Ø§ Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");

      userName.textContent = username;
      userImage.src = profileImageData;

      page1.classList.add("hidden");
      page2.classList.remove("hidden");

      // Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† Ø¯ÙˆØ±Ø¨ÛŒÙ†
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        video.style.display = "none";
        clearInterval(intervalId);
      }
    }

    // ---------------- Ø¨Ø§Ø²ÛŒ Ù‡Ù…Ø§Ù†Ù†Ø¯ Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ ----------------
    const ROWS = 7, COLS = 9;
    let board, gameOver, currentPlayer, selfPlayData = [];

    const table = document.getElementById("board");
    const status = document.getElementById("status");
    const dataOutput = document.getElementById("data");

    function startGame(starter) {
      board = Array.from({ length: ROWS }, () => Array(COLS).fill(0));
      gameOver = false;
      currentPlayer = starter;
      selfPlayData = [];
      status.innerText = currentPlayer === 'player' ? "Ù†ÙˆØ¨Øª Ø´Ù…Ø§Ø³Øª" : "Ù†ÙˆØ¨Øª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ";
      renderBoard();
      if (starter === 'ai') setTimeout(aiMove, 500);
    }

    function renderBoard() {
      table.innerHTML = "";
      for (let r = 0; r < ROWS; r++) {
        const row = document.createElement("tr");
        for (let c = 0; c < COLS; c++) {
          const cell = document.createElement("td");
          if (board[r][c] === 1) cell.className = "player";
          if (board[r][c] === 2) cell.className = "ai";
          cell.addEventListener("click", () => playerMove(c));
          row.appendChild(cell);
        }
        table.appendChild(row);
      }
    }

    function playerMove(col) {
      if (gameOver || currentPlayer !== 'player') return;
      for (let r = ROWS - 1; r >= 0; r--) {
        if (board[r][col] === 0) {
          board[r][col] = 1;
          renderBoard();
          if (checkWin(1)) {
            status.innerText = "Ø´Ù…Ø§ Ø¨Ø±Ø¯ÛŒØ¯!";
            gameOver = true;
          } else if (isDraw()) {
            status.innerText = "Ù…Ø³Ø§ÙˆÛŒ Ø´Ø¯!";
            gameOver = true;
          } else {
            currentPlayer = 'ai';
            status.innerText = "Ù†ÙˆØ¨Øª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ";
            setTimeout(aiMove, 300);
          }
          return;
        }
      }
    }

    function aiMove() {
      if (gameOver) return;
      const move = getBestMove(board, 2);
      if (move === -1) return;
      for (let r = ROWS - 1; r >= 0; r--) {
        if (board[r][move] === 0) {
          board[r][move] = 2;
          renderBoard();
          if (checkWin(2)) {
            status.innerText = "Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¨Ø±Ø¯!";
            gameOver = true;
          } else if (isDraw()) {
            status.innerText = "Ù…Ø³Ø§ÙˆÛŒ Ø´Ø¯!";
            gameOver = true;
          } else {
            currentPlayer = 'player';
            status.innerText = "Ù†ÙˆØ¨Øª Ø´Ù…Ø§Ø³Øª";
          }
          return;
        }
      }
    }

    function isDraw() {
      return board.flat().every(c => c !== 0);
    }

    function checkWin(player) {
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          if (c + 4 < COLS && board[r][c] === player && board[r][c+1] === player && board[r][c+2] === player && board[r][c+3] === player && board[r][c+4] === player) return true;
          if (r + 4 < ROWS && board[r][c] === player && board[r+1][c] === player && board[r+2][c] === player && board[r+3][c] === player && board[r+4][c] === player) return true;
          if (r + 4 < ROWS && c + 4 < COLS && board[r][c] === player && board[r+1][c+1] === player && board[r+2][c+2] === player && board[r+3][c+3] === player && board[r+4][c+4] === player) return true;
          if (r + 4 < ROWS && c - 4 >= 0 && board[r][c] === player && board[r+1][c-1] === player && board[r+2][c-2] === player && board[r+3][c-3] === player && board[r+4][c-4] === player) return true;
        }
      }
      return false;
    }

    function getAvailableRow(col) {
      for (let r = ROWS - 1; r >= 0; r--) if (board[r][col] === 0) return r;
      return -1;
    }

    function getBestMove(boardState, player) {
      const scores = Array(COLS).fill(0);
      for (let col = 0; col < COLS; col++) {
        const row = getAvailableRow(col);
        if (row !== -1) scores[col] = Math.random(); // ØªØµØ§Ø¯ÙÛŒ Ø³Ø§Ø¯Ù‡
      }
      return scores.indexOf(Math.max(...scores));
    }

    function selfPlay() {
      startGame('ai');
      let current = 1;
      function nextTurn() {
        if (gameOver) return;
        const move = getBestMove(board, current);
        const r = getAvailableRow(move);
        board[r][move] = current;
        renderBoard();
        if (checkWin(current)) {
          status.innerText = `Ø¨Ø§Ø²ÛŒÚ©Ù† ${current} Ø¨Ø±Ø¯`;
          gameOver = true;
        } else if (isDraw()) {
          status.innerText = "Ù…Ø³Ø§ÙˆÛŒ Ø´Ø¯!";
          gameOver = true;
        } else {
          current = current === 1 ? 2 : 1;
          setTimeout(nextTurn, 200);
        }
      }
      nextTurn();
    }
  </script>
</body>
</html>
